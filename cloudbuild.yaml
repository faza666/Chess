steps:
  - name: mcr.microsoft.com/dotnet/sdk:6.0
    id: TEST_RESTORE_SOURCE
    entrypoint: dotnet
    args:
      - restore
      - Web/Chess.Web/Chess.Web.csproj
    dir: src

  - name: mcr.microsoft.com/dotnet/sdk:6.0
    id: TEST_BUILD
    entrypoint: dotnet
    args:
      - build
      - -c
      - Release
    dir: src

  - name: mcr.microsoft.com/dotnet/sdk:6.0
    id: UNIT_TEST_SOURCE
    entrypoint: dotnet
    args:
      - test
      - -c
      - Release
    dir: src
  
  - name: gcr.io/cloud-builders/docker
    id: 'BUILD_DOCKER_IMAGE'
    args:
     - build
     - -t
     - $_SERVICE_IMAGE:latest
     - -t
     - $_SERVICE_IMAGE:$COMMIT_SHA
     - -t
     - $_SERVICE_IMAGE:$BUILD_ID
     - --build-arg=DEFAULT_SECRET_PASSWORD
     - .
     - -f
     - Dockerfile
    dir: src
    timeout: 1600s
    secretEnv: ['DEFAULT_SECRET_PASSWORD']

# Test Image Docker Artifact 
  - name: mcr.microsoft.com/dotnet/sdk:6.0-alpine
    id  : TEST_IMAGE
    args:
      - test
      - --image-url=$_SERVICE_IMAGE:$COMMIT_SHA

# Docker Push Image to Artifact Registry
  - name: gcr.io/cloud-builders/docker
    id  : PUSH
    args: 
      - push
      - $_SERVICE_IMAGE:$COMMIT_SHA

# Docker Deploy Image from Artifact Registry
  - name: gcr.io/cloud-builders/gcloud
    id  : DEPLOY_APPLICATION
    args:
      - app
      - deploy
      - --image-url=$_SERVICE_IMAGE:$COMMIT_SHA
    # secretEnv: ['DEFAULT_SECRET_PASSWORD']
    dir: src

availableSecrets:
  secretManager:
  - versionName: 'projects/$PROJECT_ID/secrets/chess-db-user-password/versions/1'
    env: 'DEFAULT_SECRET_PASSWORD'

substitutions:
    _SERVICE_IMAGE          : ${_SERVICE_REGION}-docker.pkg.dev/${PROJECT_ID}/${_DOCKER_REGISTRY}/${_DOCKER_IMAGENAME}
    _SERVICE_REGION         : europe-central2
    _DOCKER_REGISTRY        : chess-application
    _DOCKER_IMAGENAME       : chess-staging


images:
- '$_SERVICE_IMAGE:latest'
- '$_SERVICE_IMAGE:$COMMIT_SHA'
- '$_SERVICE_IMAGE:$BUILD_ID'
